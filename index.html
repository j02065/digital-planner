<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Digital Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c5f4f;
            --accent: #d4775d;
            --paper: #faf8f3;
            --ink: #1a1a1a;
            --line: #d4c5b0;
            --shadow: rgba(44, 95, 79, 0.15);
            --highlight-yellow: #fff4a3;
            --highlight-pink: #ffc4d6;
            --highlight-green: #c4ffb3;
            --highlight-blue: #c4e3ff;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, #e8dcc8 0%, #f5f0e8 100%);
            color: var(--ink);
            min-height: 100vh;
            padding: 10px;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--paper);
            border-radius: 4px;
            box-shadow: 0 4px 16px var(--shadow), 0 8px 40px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: var(--primary);
            color: var(--paper);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .btn {
            padding: 6px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #c26852;
        }

        .btn-small {
            padding: 3px 8px;
            font-size: 11px;
        }

        .controls {
            padding: 10px 24px;
            background: white;
            border-bottom: 2px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-switcher {
            display: flex;
            gap: 6px;
        }

        .view-btn {
            padding: 5px 12px;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .date-nav {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-nav button {
            padding: 5px 10px;
            background: var(--paper);
            border: 1px solid var(--line);
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .date-nav button:hover {
            background: var(--primary);
            color: white;
        }

        .current-period {
            font-size: 16px;
            font-weight: 600;
            min-width: 220px;
            text-align: center;
        }

        .planner-content {
            padding: 16px;
        }

        /* Weekly View - Single Page */
        .weekly-single-page {
            background: white;
            border: 2px solid var(--primary);
            padding: 16px;
            border-radius: 4px;
        }

        .page-header {
            text-align: center;
            font-size: 11px;
            color: #666;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--line);
        }

        .days-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .day-cell {
            border: 1px solid var(--line);
            border-radius: 2px;
            overflow: hidden;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .day-cell-header {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid var(--line);
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-cell-header:hover {
            background: var(--primary);
            color: white;
        }

        .day-number {
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
        }

        .day-name {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #666;
            margin-top: 2px;
        }

        .day-cell-header:hover .day-name {
            color: white;
        }

        .day-content {
            padding: 6px;
            background: repeating-linear-gradient(
                transparent,
                transparent 15px,
                var(--line) 15px,
                var(--line) 16px
            );
            min-height: 140px;
            font-size: 10px;
            line-height: 1.3;
            flex: 1;
            cursor: pointer;
        }

        .day-event {
            background: rgba(212, 119, 93, 0.15);
            border-left: 2px solid var(--accent);
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 1px;
            font-size: 9px;
        }

        .event-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            color: var(--primary);
            font-weight: 500;
        }

        .day-timeblock {
            position: relative;
            margin-bottom: 2px;
            padding: 2px 3px;
            min-height: 14px;
        }

        .timeblock-stack {
            position: relative;
            margin-bottom: 2px;
            padding: 2px 3px;
            min-height: 14px;
        }

        .timeblock-bg {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            opacity: 0.3;
            border-radius: 2px;
        }

        .timeblock-bg.yellow { background: var(--highlight-yellow); }
        .timeblock-bg.pink { background: var(--highlight-pink); }
        .timeblock-bg.green { background: var(--highlight-green); }
        .timeblock-bg.blue { background: var(--highlight-blue); }

        .timeblock-text {
            position: relative;
            font-family: 'Permanent Marker', cursive;
            font-size: 8px;
            text-align: center;
        }

        .timeblock-cancelled {
            position: relative;
        }

        .timeblock-cancelled::after {
            content: '✗';
            position: absolute;
            right: 2px;
            top: -2px;
            color: #f44336;
            font-size: 10px;
            font-weight: 700;
            z-index: 10;
        }

        .timeblock-done::before {
            content: '✓';
            position: absolute;
            right: 2px;
            top: -2px;
            color: #f44336;
            font-size: 10px;
            font-weight: 700;
            z-index: 10;
        }

        /* Day Task Grid */
        .day-task-grid {
            border-top: 2px solid var(--primary);
            background: white;
            cursor: pointer;
        }

        .day-task-grid-header {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: var(--primary);
            color: white;
        }

        .day-grid-col {
            padding: 4px 2px;
            text-align: center;
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .day-grid-col:last-child {
            border-right: none;
        }

        .day-task-grid-content {
            background: repeating-linear-gradient(
                transparent,
                transparent 13px,
                var(--line) 13px,
                var(--line) 14px
            );
            min-height: 84px;
        }

        .day-task-row {
            display: grid;
            grid-template-columns: 12px 22px 1fr 20px 28px;
            gap: 2px;
            padding: 2px 4px;
            font-size: 9px;
            align-items: center;
            min-height: 14px;
        }

        .day-task-row-empty {
            min-height: 14px;
        }

        .day-task-check {
            width: 10px;
            height: 10px;
            border: 1px solid var(--primary);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 700;
        }

        .day-task-priority {
            font-weight: 700;
            font-size: 9px;
        }

        .priority-A { color: #c41e3a; }
        .priority-B { color: #ff8800; }
        .priority-C { color: #4a90e2; }

        .day-task-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 9px;
        }

        .day-task-tag {
            font-size: 8px;
            font-weight: 600;
            color: var(--primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day-task-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            color: #666;
            text-align: right;
        }

        /* Bottom Task Grid (removed since each day has its own now) */
        .task-grid-section {
            border-top: 2px solid var(--primary);
            padding-top: 12px;
        }

        .task-grid-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            text-align: center;
        }

        .task-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .task-column {
            border: 1px solid var(--line);
            border-radius: 2px;
            overflow: hidden;
        }

        .task-column-header {
            background: var(--primary);
            color: white;
            padding: 4px;
            font-size: 9px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
        }

        .task-column-content {
            padding: 6px;
            background: repeating-linear-gradient(
                transparent,
                transparent 15px,
                var(--line) 15px,
                var(--line) 16px
            );
            min-height: 100px;
            font-size: 10px;
        }

        /* Daily Detail View */
        .daily-detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .daily-detail-view.active {
            display: flex;
        }

        .detail-container {
            background: var(--paper);
            width: 100%;
            max-width: 1600px;
            max-height: 90vh;
            border-radius: 8px;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .detail-header {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-header h2 {
            font-size: 24px;
        }

        .close-btn {
            background: white;
            color: var(--primary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
        }

        .detail-left, .detail-right {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 4px;
            padding: 16px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--line);
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-task-list {
            background: repeating-linear-gradient(
                transparent,
                transparent 27px,
                var(--line) 27px,
                var(--line) 28px
            );
            min-height: 300px;
            padding: 8px;
            margin-bottom: 16px;
        }

        .detail-task-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: flex-start;
            min-height: 28px;
            position: relative;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .detail-task-item:hover {
            background: rgba(212, 119, 93, 0.05);
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--primary);
            border-radius: 3px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
        }

        .task-checkbox:hover {
            background: rgba(44, 95, 79, 0.1);
        }

        .task-checkbox.done {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        .task-checkbox.cancelled {
            background: #f44336;
            border-color: #f44336;
            color: white;
        }

        .task-checkbox.moved {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
        }

        .detail-task-priority {
            font-weight: 700;
            font-size: 14px;
            min-width: 30px;
        }

        .detail-task-content {
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }

        .detail-task-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        .detail-task-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #666;
            margin-left: 8px;
        }

        .task-actions {
            display: none;
            gap: 4px;
            margin-left: auto;
        }

        .detail-task-item:hover .task-actions {
            display: flex;
        }

        .action-btn {
            padding: 2px 6px;
            border: 1px solid var(--line);
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .add-task-form {
            border-top: 2px solid var(--line);
            padding-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-input-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .task-input-row select,
        .task-input-row input {
            padding: 6px;
            border: 1px solid var(--line);
            border-radius: 3px;
            font-family: 'Crimson Pro', serif;
            font-size: 13px;
        }

        .task-input-row select {
            width: 60px;
        }

        .task-input-row input[type="number"] {
            width: 60px;
        }

        .task-input-row input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        .task-input-row input[type="time"] {
            width: 90px;
        }

        .time-grid {
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 0;
            border: 1px solid var(--line);
        }

        .time-slot {
            border-bottom: 1px solid var(--line);
            padding: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #666;
            background: #f9f9f9;
            text-align: right;
        }

        .time-content {
            border-bottom: 1px solid var(--line);
            border-left: 2px solid var(--primary);
            padding: 8px;
            min-height: 50px;
            position: relative;
        }

        .time-block-item {
            position: relative;
            margin-bottom: 4px;
            padding: 4px 8px;
        }

        .time-block-highlight {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            opacity: 0.4;
            border-radius: 3px;
        }

        .time-block-highlight.yellow { background: var(--highlight-yellow); }
        .time-block-highlight.pink { background: var(--highlight-pink); }
        .time-block-highlight.green { background: var(--highlight-green); }
        .time-block-highlight.blue { background: var(--highlight-blue); }

        .time-block-content {
            position: relative;
            font-family: 'Permanent Marker', cursive;
            font-size: 12px;
        }

        .time-block-content::before { content: '|<--'; margin-right: 4px; }
        .time-block-content::after { content: '-->|'; margin-left: 4px; }

        .time-block-cancelled {
            position: relative;
        }

        .time-block-cancelled::after {
            content: '✗';
            position: absolute;
            right: 5px;
            top: 0;
            color: #f44336;
            font-size: 14px;
            font-weight: 700;
            z-index: 10;
        }

        .time-block-done::before {
            content: '✓';
            position: absolute;
            right: 5px;
            top: 0;
            color: #f44336;
            font-size: 14px;
            font-weight: 700;
            z-index: 10;
        }

        .detail-bottom {
            padding: 0 20px 20px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 4px;
            padding: 16px;
        }

        .category-box {
            border: 1px solid var(--line);
            border-radius: 4px;
            padding: 10px;
            min-height: 80px;
            background: repeating-linear-gradient(
                transparent,
                transparent 19px,
                var(--line) 19px,
                var(--line) 20px
            );
        }

        .category-box h4 {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: white;
            padding: 3px 0;
        }

        .category-task {
            font-size: 12px;
            padding: 3px 0;
            line-height: 1.3;
        }

        /* Move Task Modal */
        .move-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 20px;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .move-modal.active {
            display: block;
        }

        .modal-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .mini-calendar {
            margin-bottom: 16px;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calendar-month {
            font-weight: 700;
            font-size: 14px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            color: #666;
            padding: 4px;
        }

        .calendar-day {
            text-align: center;
            padding: 6px;
            border: 1px solid var(--line);
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-day.selected {
            background: var(--accent);
            color: white;
            font-weight: 700;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .time-selector {
            margin-bottom: 16px;
        }

        .time-selector label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .time-selector input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--line);
            border-radius: 3px;
            font-size: 13px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Monthly View */
        .monthly-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--line);
            border: 1px solid var(--line);
        }

        .month-day {
            background: white;
            min-height: 140px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-day:hover {
            background: #f9f9f9;
        }

        .month-day.other-month {
            background: #f5f5f5;
            opacity: 0.6;
        }

        .month-day-number {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .month-priorities {
            margin-bottom: 8px;
        }

        .month-priority {
            font-size: 10px;
            padding: 3px 5px;
            margin-bottom: 3px;
            border-radius: 2px;
            font-weight: 600;
        }

        .month-priority.A {
            background: #ffebee;
            color: #c41e3a;
            border-left: 2px solid #c41e3a;
        }

        .month-priority.B {
            background: #fff3e0;
            color: #ff8800;
            border-left: 2px solid #ff8800;
        }

        .month-events {
            font-size: 9px;
        }

        .month-event {
            background: rgba(212, 119, 93, 0.2);
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 2px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Advanced Digital Planner</h1>
            <button class="btn" onclick="handleAuth()">Connect Outlook</button>
        </div>

        <div class="controls">
            <div class="view-switcher">
                <button class="view-btn active" onclick="switchView('week')">Week</button>
                <button class="view-btn" onclick="switchView('month')">Month</button>
            </div>
            <div class="date-nav">
                <button onclick="navigateDate(-1)">←</button>
                <div class="current-period" id="currentPeriod"></div>
                <button onclick="navigateDate(1)">→</button>
                <button onclick="goToToday()">Today</button>
            </div>
        </div>

        <div class="planner-content" id="plannerContent"></div>
    </div>

    <!-- Daily Detail View Modal -->
    <div class="daily-detail-view" id="dailyDetailView">
        <div class="detail-container">
            <div class="detail-header">
                <h2 id="detailDate"></h2>
                <button class="close-btn" onclick="closeDetailView()">×</button>
            </div>
            <div class="detail-content">
                <div class="detail-left">
                    <div class="section-title">ABC Priorities & Tasks</div>
                    <div class="detail-task-list" id="detailTasks"></div>
                    <div class="add-task-form">
                        <div class="task-input-row">
                            <select id="detailPriority">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                            <input type="number" id="detailOrder" placeholder="#" min="0" value="1">
                            <input type="text" id="detailTaskText" placeholder="Task description">
                        </div>
                        <div class="task-input-row">
                            <input type="text" id="detailTag" placeholder="Tag" list="tagsList">
                            <datalist id="tagsList"></datalist>
                            <input type="time" id="detailTimeStart" placeholder="Start time">
                            <input type="time" id="detailTimeEnd" placeholder="End time">
                            <select id="detailHighlight">
                                <option value="">No highlight</option>
                                <option value="yellow">Yellow</option>
                                <option value="pink">Pink</option>
                                <option value="green">Green</option>
                                <option value="blue">Blue</option>
                            </select>
                            <button class="btn btn-small" onclick="addDetailTask()">Add</button>
                        </div>
                    </div>
                </div>
                <div class="detail-right">
                    <div class="section-title">Daily Schedule (6:00 AM - 10:00 PM)</div>
                    <div class="time-grid" id="detailTimeGrid"></div>
                </div>
            </div>
            <div class="detail-bottom">
                <div class="section-title">
                    Task Categories
                    <button class="btn btn-small" onclick="showCategorySelector()">Select Categories (4 max)</button>
                </div>
                <div class="category-grid" id="categoryGrid"></div>
            </div>
        </div>
    </div>

    <!-- Move Task Modal -->
    <div class="move-modal" id="moveModal">
        <div class="modal-header">Move Task to Another Date</div>
        <div class="mini-calendar">
            <div class="calendar-nav">
                <button class="btn btn-small" onclick="moveCalendarMonth(-1)">←</button>
                <div class="calendar-month" id="moveCalendarMonth"></div>
                <button class="btn btn-small" onclick="moveCalendarMonth(1)">→</button>
            </div>
            <div class="calendar-grid" id="moveCalendarGrid"></div>
        </div>
        <div class="time-selector">
            <label>Start Time:</label>
            <input type="time" id="moveTimeStart">
            <label style="margin-top: 8px;">End Time:</label>
            <input type="time" id="moveTimeEnd">
        </div>
        <div class="modal-actions">
            <button class="btn btn-small" onclick="closeMoveModal()">Cancel</button>
            <button class="btn btn-small" onclick="resetTaskStatus()" style="background: #999;">Leave Blank</button>
            <button class="btn btn-small" onclick="confirmMoveTask()">Move Task</button>
        </div>
    </div>

    <!-- Category Selector Modal -->
    <div class="move-modal" id="categoryModal">
        <div class="modal-header">Select Up To 4 Categories to Display</div>
        <div id="categoryCheckboxes" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;"></div>
        <div class="modal-actions">
            <button class="btn btn-small" onclick="closeCategoryModal()">Done</button>
        </div>
    </div>

    <script>
        let currentView = 'week';
        let currentDate = new Date();
        let plannerData = {};
        let outlookEvents = [];
        let globalSettings = {
            selectedCategories: []
        };
        let currentEditingTask = null;
        let moveCalendarDate = new Date();
        let taskToMove = null;

        // Initialize
        loadData();
        renderView();

        function loadData() {
            const saved = localStorage.getItem('advanced-planner-data-v4');
            if (saved) {
                plannerData = JSON.parse(saved);
            }
            const settings = localStorage.getItem('planner-settings');
            if (settings) {
                globalSettings = JSON.parse(settings);
            }
        }

        function saveData() {
            localStorage.setItem('advanced-planner-data-v4', JSON.stringify(plannerData));
            localStorage.setItem('planner-settings', JSON.stringify(globalSettings));
        }

        function getDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDayData(date) {
            const key = getDateKey(date);
            if (!plannerData[key]) {
                plannerData[key] = { tasks: [] };
            }
            return plannerData[key];
        }

        function handleAuth() {
            alert('Demo mode. Follow SETUP_GUIDE.md to connect Outlook.');
            loadSampleEvents();
            renderView();
        }

        function loadSampleEvents() {
            const today = new Date();
            outlookEvents = [
                {
                    subject: 'Team Standup',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 0),
                    end: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 30)
                },
                {
                    subject: 'Project Review',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 14, 0),
                    end: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 15, 30)
                },
                {
                    subject: 'Client Meeting',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 10, 0),
                    end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 11, 0)
                }
            ];
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderView();
        }

        function navigateDate(direction) {
            if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }
            renderView();
        }

        function goToToday() {
            currentDate = new Date();
            renderView();
        }

        function renderView() {
            if (currentView === 'week') {
                renderWeekView();
            } else {
                renderMonthView();
            }
        }

        function renderWeekView() {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000);
            const periodText = `Week of ${formatDate(startOfWeek)}`;
            document.getElementById('currentPeriod').textContent = periodText;
            
            let html = '<div class="weekly-single-page">';
            html += `<div class="page-header">${periodText}</div>`;
            
            html += '<div class="days-row">';
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                html += renderDayCell(date, days[i]);
            }
            html += '</div>';
            
            html += '</div>';
            document.getElementById('plannerContent').innerHTML = html;
        }

        function renderDayCell(date, dayName) {
            const dateKey = getDateKey(date);
            const dayData = getDayData(date);
            
            let html = `<div class="day-cell">`;
            
            // Header (clickable to open detail view)
            html += `
                <div class="day-cell-header" onclick="openDetailView('${dateKey}')">
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-name">${dayName}</div>
                </div>
            `;
            
            // Content area (also clickable)
            html += `<div class="day-content" onclick="openDetailView('${dateKey}')">`;
            
            // Outlook events
            const events = outlookEvents.filter(e => isSameDay(new Date(e.start), date));
            events.forEach(e => {
                html += `
                    <div class="day-event">
                        <div class="event-time">${formatTime(new Date(e.start))}</div>
                        ${truncate(e.subject, 12)}
                    </div>
                `;
            });
            
            // Time-blocked tasks with smart filtering (only hide completed when space is limited)
            const allTimeBlockedTasks = dayData.tasks.filter(t => t.timeStart && t.highlight);
            
            // Smart filtering: only hide completed if we have too many tasks
            let displayTimeBlocks;
            if (allTimeBlockedTasks.length > 6) {
                // Too many time blocks - hide completed ones
                displayTimeBlocks = allTimeBlockedTasks.filter(t => !t.status || t.status === '');
            } else {
                // Enough space - show all including completed
                displayTimeBlocks = allTimeBlockedTasks;
            }
            
            const timeSlots = {};
            
            displayTimeBlocks.forEach(t => {
                const slot = t.timeStart;
                if (!timeSlots[slot]) timeSlots[slot] = [];
                timeSlots[slot].push(t);
            });
            
            Object.keys(timeSlots).sort().forEach(slot => {
                const tasks = timeSlots[slot];
                const timeDisplay = formatTimeSimple(slot);
                
                if (tasks.length === 1) {
                    const t = tasks[0];
                    const statusClass = t.status === 'done' ? 'timeblock-done' : 
                                       (t.status === 'cancelled' || t.status === 'moved') ? 'timeblock-cancelled' : '';
                    html += `
                        <div class="day-timeblock">
                            <div class="timeblock-bg ${t.highlight}"></div>
                            <div class="timeblock-text ${statusClass}">${timeDisplay} |<-- ${t.priority}${t.order} ${truncate(t.text, 6)} -->|</div>
                        </div>
                    `;
                } else {
                    // Multiple tasks - check if any are completed
                    const hasCompleted = tasks.some(t => t.status === 'done' || t.status === 'cancelled' || t.status === 'moved');
                    const statusClass = hasCompleted ? 'timeblock-cancelled' : '';
                    html += `
                        <div class="timeblock-stack">
                            <div class="timeblock-bg ${tasks[0].highlight}"></div>
                            <div class="timeblock-text ${statusClass}">${timeDisplay} |<-- ${tasks.map(t => t.priority + t.order).join(' ')} -->|</div>
                        </div>
                    `;
                }
            });
            
            html += `</div>`; // Close day-content
            
            // Day task grid (checkbox | priority | task | tag | time)
            html += renderDayTaskGrid(dayData, date);
            
            html += `</div>`; // Close day-cell
            
            return html;
        }

        function renderDayTaskGrid(dayData, date) {
            const dateKey = getDateKey(date);
            const allTasks = dayData.tasks || [];
            
            // Smart filtering: only hide completed tasks if total > 6
            let displayTasks;
            if (allTasks.length > 6) {
                // Show only active tasks when over limit
                displayTasks = allTasks.filter(t => !t.status || t.status === '');
            } else {
                // Show all tasks when under limit
                displayTasks = allTasks;
            }
            
            // Do NOT sort - keep original order
            
            let html = `
                <div class="day-task-grid" onclick="openDetailView('${dateKey}')">
                    <div class="day-task-grid-header">
                        <div class="day-grid-col">ABC</div>
                        <div class="day-grid-col">Daily Priorities</div>
                        <div class="day-grid-col">Task List</div>
                    </div>
                    <div class="day-task-grid-content">
            `;
            
            // Show up to 6 tasks
            displayTasks.slice(0, 6).forEach((task) => {
                const actualIndex = allTasks.indexOf(task);
                const checkSymbol = task.status === 'done' ? '✓' : 
                                  task.status === 'cancelled' ? 'X' : 
                                  task.status === 'moved' ? '→' : '';
                
                // Format moved date if present
                let movedDateDisplay = '';
                if (task.status === 'moved' && task.movedTo) {
                    const [year, month, day] = task.movedTo.split('-');
                    movedDateDisplay = `<div style="font-size: 6px; text-align: center; line-height: 1; margin-bottom: 1px;">${month}/${day}/${year.slice(2)}</div>`;
                }
                
                html += `
                    <div class="day-task-row">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            ${movedDateDisplay}
                            <div class="day-task-check" onclick="cycleWeeklyTaskStatus('${dateKey}', ${actualIndex}); event.stopPropagation();">${checkSymbol}</div>
                        </div>
                        <div class="day-task-priority priority-${task.priority}">${task.priority}${task.order}</div>
                        <div class="day-task-name">${truncate(task.text, 5)}</div>
                        <div class="day-task-tag">${task.tag ? truncate(task.tag, 3) : ''}</div>
                        <div class="day-task-time">${task.timeStart ? formatTimeSimple(task.timeStart) : ''}</div>
                    </div>
                `;
            });
            
            // Fill remaining rows
            for (let i = displayTasks.length; i < 6; i++) {
                html += `<div class="day-task-row day-task-row-empty"></div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function formatTimeSimple(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const hour12 = hours % 12 || 12;
            return `${hour12}${ampm}`;
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('currentPeriod').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = '<div class="monthly-view">';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            days.forEach(day => {
                html += `<div class="month-day" style="background: var(--primary); color: white; font-weight: 700; text-align: center; padding: 10px; cursor: default; min-height: auto;">${day}</div>`;
            });
            
            const currentDateObj = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const isOtherMonth = currentDateObj.getMonth() !== month;
                const dayData = getDayData(currentDateObj);
                const dateKey = getDateKey(currentDateObj);
                
                html += `
                    <div class="month-day ${isOtherMonth ? 'other-month' : ''}" onclick="openDetailView('${dateKey}')">
                        <div class="month-day-number">${currentDateObj.getDate()}</div>
                        ${renderMonthPriorities(dayData)}
                        ${renderMonthEvents(currentDateObj)}
                    </div>
                `;
                currentDateObj.setDate(currentDateObj.getDate() + 1);
            }
            
            html += '</div>';
            document.getElementById('plannerContent').innerHTML = html;
        }

        function renderMonthPriorities(dayData) {
            if (!dayData.tasks || dayData.tasks.length === 0) return '';
            
            const activeTasks = dayData.tasks.filter(t => t.status !== 'done' && t.status !== 'cancelled');
            const sorted = [...activeTasks].sort((a, b) => {
                if (a.priority !== b.priority) return a.priority.localeCompare(b.priority);
                return a.order - b.order;
            });
            
            const top2 = sorted.slice(0, 2);
            
            return '<div class="month-priorities">' + top2.map(task => `
                <div class="month-priority ${task.priority}">${task.priority}${task.order} ${truncate(task.text, 18)}</div>
            `).join('') + '</div>';
        }

        function renderMonthEvents(date) {
            const events = outlookEvents.filter(e => isSameDay(new Date(e.start), date)).slice(0, 3);
            if (events.length === 0) return '';
            
            return '<div class="month-events">' + events.map(e => `
                <div class="month-event">${formatTime(new Date(e.start))} ${truncate(e.subject, 12)}</div>
            `).join('') + '</div>';
        }

        let currentDetailDate = null;

        function openDetailView(dateKey) {
            currentDetailDate = dateKey;
            const [year, month, day] = dateKey.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            
            document.getElementById('detailDate').textContent = formatFullDate(date);
            document.getElementById('dailyDetailView').classList.add('active');
            
            updateTagsList();
            renderDetailView();
        }

        function closeDetailView() {
            document.getElementById('dailyDetailView').classList.remove('active');
            renderView();
        }

        function updateTagsList() {
            const allTags = new Set();
            Object.values(plannerData).forEach(day => {
                day.tasks.forEach(task => {
                    if (task.tag) allTags.add(task.tag);
                });
            });
            
            const datalist = document.getElementById('tagsList');
            datalist.innerHTML = Array.from(allTags).map(tag => `<option value="${tag}">`).join('');
        }

        function renderDetailView() {
            const dayData = plannerData[currentDetailDate] || { tasks: [] };
            
            // Do NOT sort - keep original order as entered by user
            const allTasks = dayData.tasks;
            
            let tasksHtml = '';
            if (allTasks.length === 0) {
                tasksHtml = '<div style="color: #999; text-align: center; padding: 20px;">No tasks yet.</div>';
            } else {
                allTasks.forEach((task) => {
                    const taskIndex = dayData.tasks.indexOf(task);
                    const checkStatus = task.status || '';
                    const checkSymbol = checkStatus === 'done' ? '✓' : checkStatus === 'cancelled' ? 'X' : checkStatus === 'moved' ? '→' : '';
                    
                    // Format moved date if present
                    let movedDateDisplay = '';
                    if (task.status === 'moved' && task.movedTo) {
                        const [year, month, day] = task.movedTo.split('-');
                        movedDateDisplay = `<div style="font-size: 9px; color: #666; margin-top: 2px;">→ ${month}/${day}/${year.slice(2)}</div>`;
                    }
                    
                    tasksHtml += `
                        <div class="detail-task-item">
                            <div class="task-checkbox ${checkStatus}" onclick="cycleTaskStatus(${taskIndex})" title="Click to cycle: done → cancelled → move">${checkSymbol}${movedDateDisplay}</div>
                            <div class="detail-task-priority priority-${task.priority}">${task.priority}${task.order}</div>
                            <div class="detail-task-content">
                                ${task.text}
                                ${task.tag ? `<span class="detail-task-tag">${task.tag}</span>` : ''}
                                ${task.timeStart ? `<span class="detail-task-time">${task.timeStart}</span>` : ''}
                            </div>
                            <div class="task-actions">
                                <button class="action-btn" onclick="editTask(${taskIndex}); event.stopPropagation();">Edit</button>
                                <button class="action-btn" onclick="deleteTask(${taskIndex}); event.stopPropagation();">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('detailTasks').innerHTML = tasksHtml;
            
            // Render time grid (show ALL tasks including completed with visual indicators)
            let timeHtml = '';
            for (let hour = 6; hour <= 22; hour++) {
                const hour12 = hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const timeStr = `${hour12}:00 ${ampm}`;
                
                const tasksInHour = dayData.tasks.filter(t => {
                    if (!t.timeStart) return false;
                    const [taskHour] = t.timeStart.split(':').map(Number);
                    return taskHour === hour;
                });
                
                timeHtml += `
                    <div class="time-slot" onclick="fillTimeSlot(${hour})" style="cursor: pointer;" title="Click to add task at this time">${timeStr}</div>
                    <div class="time-content" onclick="fillTimeSlot(${hour})" style="cursor: pointer;">
                        ${tasksInHour.map(t => {
                            const statusClass = t.status === 'done' ? 'time-block-done' : 
                                               (t.status === 'cancelled' || t.status === 'moved') ? 'time-block-cancelled' : '';
                            return `
                            <div class="time-block-item">
                                ${t.highlight ? `<div class="time-block-highlight ${t.highlight}"></div>` : ''}
                                <div class="time-block-content ${statusClass}">${t.priority}${t.order} ${t.text}</div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            }
            document.getElementById('detailTimeGrid').innerHTML = timeHtml;
            
            renderCategoryGrid();
        }

        function renderCategoryGrid() {
            const dayData = plannerData[currentDetailDate] || { tasks: [] };
            
            const allTags = new Set();
            Object.values(plannerData).forEach(day => {
                day.tasks.forEach(task => {
                    if (task.tag) allTags.add(task.tag);
                });
            });
            
            const displayCategories = globalSettings.selectedCategories.filter(cat => allTags.has(cat));
            
            let categoryHtml = '';
            if (displayCategories.length === 0) {
                categoryHtml = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No categories selected. Click "Select Categories" to choose up to 4.</div>';
            } else {
                displayCategories.forEach(tag => {
                    const tasksInCategory = dayData.tasks.filter(t => 
                        t.tag === tag && 
                        t.status !== 'done' && 
                        t.status !== 'cancelled' && 
                        t.status !== 'moved'
                    );
                    categoryHtml += `
                        <div class="category-box">
                            <h4>${tag}</h4>
                            ${tasksInCategory.length > 0 ? tasksInCategory.map(t => `
                                <div class="category-task">${t.priority}${t.order} ${t.text}</div>
                            `).join('') : '<div style="color: #999; font-size: 11px;">No tasks</div>'}
                        </div>
                    `;
                });
            }
            
            document.getElementById('categoryGrid').innerHTML = categoryHtml;
        }

        function showCategorySelector() {
            const allTags = new Set();
            Object.values(plannerData).forEach(day => {
                day.tasks.forEach(task => {
                    if (task.tag) allTags.add(task.tag);
                });
            });
            
            let html = '';
            Array.from(allTags).sort().forEach(tag => {
                const checked = globalSettings.selectedCategories.includes(tag) ? 'checked' : '';
                html += `
                    <div style="padding: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" value="${tag}" ${checked} onchange="updateCategorySelection()" style="width: 16px; height: 16px;">
                            <span style="font-size: 14px;">${tag}</span>
                        </label>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div style="text-align: center; color: #999; padding: 20px;">No categories yet. Add tags to tasks to create categories.</div>';
            }
            
            document.getElementById('categoryCheckboxes').innerHTML = html;
            document.getElementById('categoryModal').classList.add('active');
        }

        function updateCategorySelection() {
            const checkboxes = document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]');
            const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            
            if (selected.length > 4) {
                alert('You can only select up to 4 categories');
                event.target.checked = false;
                return;
            }
            
            globalSettings.selectedCategories = selected;
            saveData();
            renderCategoryGrid();
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        function fillTimeSlot(hour) {
            // Auto-fill start and end time (1 hour block)
            const startTime = `${String(hour).padStart(2, '0')}:00`;
            const endHour = hour + 1;
            const endTime = `${String(endHour).padStart(2, '0')}:00`;
            
            document.getElementById('detailTimeStart').value = startTime;
            document.getElementById('detailTimeEnd').value = endTime;
            
            // Focus on task description field
            document.getElementById('detailTaskText').focus();
        }

        function resetTaskStatus() {
            // Reset task to blank checkbox
            if (taskToMove) {
                const dayData = plannerData[taskToMove.fromDate];
                dayData.tasks[taskToMove.index].status = '';
                saveData();
                closeMoveModal();
                renderDetailView();
                renderView();
            }
        }

        function cycleWeeklyTaskStatus(dateKey, taskIndex) {
            const dayData = plannerData[dateKey];
            const task = dayData.tasks[taskIndex];
            
            if (!task.status || task.status === '') {
                task.status = 'done';
                saveData();
                renderView();
            } else if (task.status === 'done') {
                task.status = 'cancelled';
                saveData();
                renderView();
            } else if (task.status === 'cancelled') {
                // Open detail view and show move modal
                currentDetailDate = dateKey;
                taskToMove = { task, index: taskIndex, fromDate: dateKey };
                openDetailView(dateKey);
                showMoveModal();
            } else if (task.status === 'moved') {
                task.status = '';
                delete task.movedTo;
                saveData();
                renderView();
            }
        }

        function cycleTaskStatus(index) {
            const dayData = plannerData[currentDetailDate];
            const task = dayData.tasks[index];
            
            if (!task.status || task.status === '') {
                task.status = 'done';
            } else if (task.status === 'done') {
                task.status = 'cancelled';
            } else if (task.status === 'cancelled') {
                taskToMove = { task, index, fromDate: currentDetailDate };
                showMoveModal();
                return;
            } else if (task.status === 'moved') {
                task.status = '';
            }
            
            saveData();
            renderDetailView();
            renderView();
        }

        function showMoveModal() {
            moveCalendarDate = new Date();
            const task = taskToMove.task;
            
            document.getElementById('moveTimeStart').value = task.timeStart || '';
            document.getElementById('moveTimeEnd').value = task.timeEnd || '';
            
            renderMoveCalendar();
            document.getElementById('moveModal').classList.add('active');
        }

        function closeMoveModal() {
            document.getElementById('moveModal').classList.remove('active');
            taskToMove = null;
        }

        function moveCalendarMonth(direction) {
            moveCalendarDate.setMonth(moveCalendarDate.getMonth() + direction);
            renderMoveCalendar();
        }

        function renderMoveCalendar() {
            const year = moveCalendarDate.getFullYear();
            const month = moveCalendarDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('moveCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = '';
            const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            days.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            const currentDateObj = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const isOtherMonth = currentDateObj.getMonth() !== month;
                const dateKey = getDateKey(currentDateObj);
                
                html += `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''}" 
                         onclick="selectMoveDate('${dateKey}')"
                         data-date="${dateKey}">
                        ${currentDateObj.getDate()}
                    </div>
                `;
                currentDateObj.setDate(currentDateObj.getDate() + 1);
            }
            
            document.getElementById('moveCalendarGrid').innerHTML = html;
        }

        function selectMoveDate(dateKey) {
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            event.target.dataset.selectedDate = dateKey;
        }

        function confirmMoveTask() {
            const selectedDay = document.querySelector('.calendar-day.selected');
            if (!selectedDay) {
                alert('Please select a date');
                return;
            }
            
            const toDate = selectedDay.dataset.date || selectedDay.dataset.selectedDate;
            const timeStart = document.getElementById('moveTimeStart').value;
            const timeEnd = document.getElementById('moveTimeEnd').value;
            
            // Copy task to new date (don't remove from original)
            const fromData = plannerData[taskToMove.fromDate];
            const originalTask = fromData.tasks[taskToMove.index];
            
            // Mark original as moved with date
            originalTask.status = 'moved';
            originalTask.movedTo = toDate;
            
            // Create copy at new date
            if (!plannerData[toDate]) {
                plannerData[toDate] = { tasks: [] };
            }
            
            const copiedTask = { ...originalTask };
            copiedTask.timeStart = timeStart || copiedTask.timeStart;
            copiedTask.timeEnd = timeEnd || copiedTask.timeEnd;
            copiedTask.status = ''; // Reset status for copied task
            delete copiedTask.movedTo; // Remove movedTo from copy
            
            plannerData[toDate].tasks.push(copiedTask);
            
            saveData();
            closeMoveModal();
            renderDetailView();
            renderView();
        }

        function editTask(index) {
            const dayData = plannerData[currentDetailDate];
            const task = dayData.tasks[index];
            
            document.getElementById('detailPriority').value = task.priority;
            document.getElementById('detailOrder').value = task.order;
            document.getElementById('detailTaskText').value = task.text;
            document.getElementById('detailTag').value = task.tag || '';
            document.getElementById('detailTimeStart').value = task.timeStart || '';
            document.getElementById('detailTimeEnd').value = task.timeEnd || '';
            document.getElementById('detailHighlight').value = task.highlight || '';
            
            currentEditingTask = index;
            document.querySelector('.add-task-form .btn').textContent = 'Update';
        }

        function deleteTask(index) {
            if (!confirm('Delete this task?')) return;
            
            const dayData = plannerData[currentDetailDate];
            dayData.tasks.splice(index, 1);
            
            saveData();
            renderDetailView();
            renderView();
        }

        function addDetailTask() {
            const priority = document.getElementById('detailPriority').value;
            const order = parseInt(document.getElementById('detailOrder').value);
            if (isNaN(order) || order < 0) {
                alert('Order must be 0 or greater');
                return;
            }
            
            const text = document.getElementById('detailTaskText').value.trim();
            const tag = document.getElementById('detailTag').value.trim();
            const timeStart = document.getElementById('detailTimeStart').value;
            const timeEnd = document.getElementById('detailTimeEnd').value;
            const highlight = document.getElementById('detailHighlight').value;
            
            if (!text) {
                alert('Please enter a task description');
                return;
            }
            
            if (!plannerData[currentDetailDate]) {
                plannerData[currentDetailDate] = { tasks: [] };
            }
            
            const task = {
                priority,
                order,
                text,
                tag: tag || null,
                timeStart: timeStart || null,
                timeEnd: timeEnd || null,
                highlight: highlight || null,
                status: ''
            };
            
            if (currentEditingTask !== null) {
                plannerData[currentDetailDate].tasks[currentEditingTask] = task;
                currentEditingTask = null;
                document.querySelector('.add-task-form .btn').textContent = 'Add';
            } else {
                plannerData[currentDetailDate].tasks.push(task);
            }
            
            document.getElementById('detailTaskText').value = '';
            document.getElementById('detailTag').value = '';
            document.getElementById('detailTimeStart').value = '';
            document.getElementById('detailTimeEnd').value = '';
            document.getElementById('detailHighlight').value = '';
            document.getElementById('detailOrder').value = '1';
            
            saveData();
            updateTagsList();
            renderDetailView();
        }

        // Utility functions
        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function formatDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function formatFullDate(date) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function formatTime(date) {
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            return `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        }

        function truncate(str, length) {
            if (!str) return '';
            return str.length > length ? str.substring(0, length) + '...' : str;
        }
    </script>
</body>
</html>
